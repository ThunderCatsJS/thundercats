<!DOCTYPE html>

<html>
    <head>
        <title>ThunderCats.js</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
        <link rel="stylesheet" media="all" href="docs/docco.css" />
    </head>
    <body>
        <div id="container">
            <div id="background"></div>
            
            <ul class="sections">
                
                
                <li id="section-1">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-1">&#182;</a>
                        </div>
                        <p><a href="https://circleci.com/gh/r3dm/thundercats"><img src="https://circleci.com/gh/r3dm/thundercats.svg?style=svg" alt="Circle CI"></a> <a href="https://waffle.io/r3dm/thundercats"><img src="https://badge.waffle.io/r3dm/thundercats.png?label=ready&amp;title=Ready" alt="Stories in Ready"></a> <a href="https://gitter.im/r3dm/thundercats?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Join the chat at https://gitter.im/r3dm/thundercats"></a></p>
<h1 id="thundercats-js">ThunderCats.js</h1>
<blockquote>
<p>Thundercats, Ho!</p>
</blockquote>
<p>A <a href="https://github.com/facebook/flux/">Flux</a> architecture implementation based on <a href="https://github.com/Reactive-Extensions/RxJS">RxJS</a></p>
<p>An exodus from <a href="https://github.com/fdecampredon/rx-flux">rx-flux</a>.</p>
<p>The <a href="https://github.com/facebook/flux/">Flux</a> architecture allows you to think of your application as an unidirectional flow of data, this module aims to facilitate the use of <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/observable.md">RxJS Observable</a> as basis for defining the relations between the different entities composing your application.</p>
<h2 id="difference-with-the-facebooks-flux">Difference with the Facebooks Flux</h2>
<p>RxFlux shares more similarities with <a href="https://github.com/spoike/refluxjs">RefluxJS</a> than with the original architecture.</p>
<ul>
<li>A store is an <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/observable.md">RxJS Observable</a> that a view layer can listen to for state</li>
<li>An action is a function and an <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/observable.md">RxJS Observable</a></li>
<li>A store subscribes to an action and updates its state accordingly.</li>
<li>actions dispatch themselves so no need for a central dispatcher.</li>
</ul>
<p>Check out our documentation (a work in progress) over at <a href="http://r3dm.github.io/thundercats">http://r3dm.github.io/thundercats</a></p>
<h2 id="development">Development</h2>
<p>Bring all the PR’s!</p>
<h3 id="tests">Tests</h3>
<p>Please at unit tests for any new code. Tests are written using Mocha and Chai.</p>
<h3 id="docs">Docs</h3>
<p>There are two sections to documentation: the guide written directly in the source and the API docs generated from Mocha test suites (in progress).</p>
<p>If you find a typo or would like to contribute to the docs, make your changes and run <code>make</code> in the root directory using the command line. This should autogenerate the documention. Then simply commit and create a PR. Super simple!</p>
<h3 id="lint">Lint</h3>
<p>I am very opiniated when it comes to code style, so please run <code>npm run lint</code> before commit changes and verify that there are no errors.</p>
<p>I find it good practice to run <code>npm test</code> (test will also lint files) before making any changes to verify that tests are already passing before making any new changes.</p>
<p>general rules to follow</p>
<ul>
<li>Horizontal space is precious, vertical space is cheap and plentiful. Keep your indenting sane and to a minimal.</li>
<li>Use named functions instead of anonomous functions assigned to variables.</li>
<li>For most cases, declare module.exports as a single object with each key a part of the files api at the top, and the named functions underneath this section. </li>
<li><h3 id="api">API</h3>
</li>
</ul>
<p>The api is still new and can be maliable for the forseeable future. If there are features you would like to see please open a new issue for discussion.</p>
<p>For the most part I want this project to support server-side rendering/isomorphic js. My first inclanation is to get it working using singletons, which presents data leakage challenges. I am sure we are up to that challenge and can come up with a viable solution.</p>

                    </div>
                    
                </li>
                
                
                <li id="section-2">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-2">&#182;</a>
                        </div>
                        <h1 id="observable-state-mixin">Observable State Mixin</h1>
<p>For your components</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Rx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rx'</span>),
    utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils'</span>),
    invariant = utils.invariant,
    isObservable = utils.isObservable,
    areObservable = utils.invariant,
    stateSubscriptions = [];

<span class="hljs-keyword">var</span> ObservableStateMixin = {

  statics: {</pre></div></div>
                    
                </li>
                
                
                <li id="section-3">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-3">&#182;</a>
                        </div>
                        <p>Allows subscriptions for all components using this mixin
to be disposed using MyComponent.disposeAllSubscriptions().</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>    disposeAllSubscriptions: disposeAllSubscriptions
  },

  getInitialState: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> displayName =
      <span class="hljs-keyword">this</span>.constructor.displayName || <span class="hljs-keyword">this</span>.constructor.name || <span class="hljs-string">''</span>;

    invariant(
      <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.getObservable === <span class="hljs-string">'function'</span>,
      <span class="hljs-string">'%s should provide "getObservable" or "getObservables" function'</span> +
        <span class="hljs-string">' or a function'</span>,
      displayName
    );

    <span class="hljs-keyword">this</span>._observableState = <span class="hljs-keyword">this</span>.getObservable(<span class="hljs-keyword">this</span>.props);

    invariant(
      areObservable(<span class="hljs-keyword">this</span>._observableState) ||
        isObservable(<span class="hljs-keyword">this</span>._observableState),
      <span class="hljs-string">'"%s.getObservable" should return an Rx.Observable or an array of '</span> +
        <span class="hljs-string">'Rx.Observables, given : %s'</span>,
      displayName,
      <span class="hljs-keyword">this</span>._observableState
    );</pre></div></div>
                    
                </li>
                
                
                <li id="section-4">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-4">&#182;</a>
                        </div>
                        <p>getObservable can be supplied an array of observables and
ThunderCats will use Rx.Observable.merge to create a single
stream of data</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (areObservable(<span class="hljs-keyword">this</span>._observableState)) {
      <span class="hljs-keyword">this</span>._observableState = Rx.Observale.merge(<span class="hljs-keyword">this</span>._observableState);
    }

    <span class="hljs-keyword">var</span> initialState = <span class="hljs-literal">null</span>;</pre></div></div>
                    
                </li>
                
                
                <li id="section-5">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-5">&#182;</a>
                        </div>
                        <p>In GIS we only want to get the initial value without subscribing,
So we use the first filter here.
You cannot use async observable here with server-side rendering as
the subscription will hang around after the component has rendered with
initial state of null;</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._observableState.first().subscribe(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> </span>{
      invariant(
        <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'object'</span>,
        <span class="hljs-string">'The observable returned by \'%s.getObservable\' should publish '</span> +
          <span class="hljs-string">'objects or null given : %s'</span>,
        displayName,
        val
      );
      initialState = val;
    });

    <span class="hljs-keyword">return</span> initialState;
  },

  componentDidMount: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{</pre></div></div>
                    
                </li>
                
                
                <li id="section-6">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-6">&#182;</a>
                        </div>
                        <p>Now that the component has mounted, we will use a long lived
the subscription</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._stateSubscription =
      <span class="hljs-keyword">this</span>._observableState.subscribe(<span class="hljs-keyword">this</span>._observer.bind(<span class="hljs-keyword">this</span>));</pre></div></div>
                    
                </li>
                
                
                <li id="section-7">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-7">&#182;</a>
                        </div>
                        <p>we save all disposable subscriptions to an array so that they can
be disposed of using MyComp.disposeAllSubscriptions()</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>    stateSubscriptions.push(<span class="hljs-keyword">this</span>.__stateSubscription);
  },

  componentWillUnmount: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
                    
                </li>
                
                
                <li id="section-8">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-8">&#182;</a>
                        </div>
                        <p>On unmount, the subscription to the observable state is disposed
and removed from the global subscription array</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._stateSubscription) {
      <span class="hljs-keyword">this</span>._stateSubscription.dispose();
      <span class="hljs-keyword">var</span> index = stateSubscriptions.indexOf(<span class="hljs-keyword">this</span>._stateSubscription);
      <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
        stateSubscriptions.splice(index, <span class="hljs-number">1</span>);
      }
    }
  },</pre></div></div>
                    
                </li>
                
                
                <li id="section-9">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-9">&#182;</a>
                        </div>
                        <p>This is the observer that will watch the observable state.
TODO: make this into a proper Rx.Observable</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  _stateObserver: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(val)</span> </span>{
    <span class="hljs-keyword">var</span> displayName =
      <span class="hljs-keyword">this</span>.constructor.displayName || <span class="hljs-keyword">this</span>.constructor.name || <span class="hljs-string">''</span>;

    invariant(
      <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'object'</span>,
      <span class="hljs-string">'The observable returned by \'%s.getObservable\' should publish '</span> +
      <span class="hljs-string">'Objects or null given : %s'</span>,
      displayName,
      val
    );

    <span class="hljs-keyword">this</span>.setState(val);
  }
};</pre></div></div>
                    
                </li>
                
                
                <li id="section-10">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-10">&#182;</a>
                        </div>
                        <p>Dispose of all the subscriptions created by this mixin.</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">disposeAllSubscriptions</span><span class="hljs-params">()</span> </span>{
  stateSubscriptions.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(subscription)</span> </span>{
    subscription.dispose();
  });
  stateSubscriptions = [];
}

<span class="hljs-built_in">module</span>.exports = ObservableStateMixin;</pre></div></div>
                    
                </li>
                
                
                <li id="section-11">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-11">&#182;</a>
                        </div>
                        <p>Original source from <a href="https://github.com/fdecampredon/rx-react">https://github.com/fdecampredon/rx-react</a></p>

                    </div>
                    
                </li>
                
                
                <li id="section-12">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-12">&#182;</a>
                        </div>
                        <h1 id="thundercats-action">ThunderCats Action</h1>
<p>A ThunderCats Action is an Observable that can be called like a function!</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Rx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rx'</span>),
    invariant = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils/invariant'</span>),
    assign = <span class="hljs-built_in">require</span>(<span class="hljs-string">'object.assign'</span>),
    slice = <span class="hljs-built_in">Array</span>.prototype.slice;</pre></div></div>
                    
                </li>
                
                
                <li id="section-13">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-13">&#182;</a>
                        </div>
                        <h2 id="create">create</h2>
<p>Create a single action object
Takes a single function <code>map</code> as an argument which will be applied
to each payload fed to this action. You can this of this as an action
creator in a traditional flux implementation</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(map)</span> </span>{
  <span class="hljs-keyword">var</span> observers = [];

  <span class="hljs-keyword">var</span> actionStart = <span class="hljs-keyword">new</span> Rx.Subject();
  <span class="hljs-keyword">var</span> actionEnd = <span class="hljs-keyword">new</span> Rx.Subject();

  <span class="hljs-keyword">var</span> action = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> map !== <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> map === <span class="hljs-string">'function'</span>) {
        value = map(value);
      } <span class="hljs-keyword">else</span> {
        value = map;
      }
    }

    actionStart.onNext(value);
    <span class="hljs-keyword">var</span> os = observers.slice(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = os.length; i &lt; len; i++) {
      os[i].onNext(value);
    }
    actionEnd.onNext();

    <span class="hljs-keyword">return</span> value;
  };

  assign(action, Rx.Observable.prototype, Rx.Subject.prototype);

  Rx.Observable.call(action, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(observer)</span> </span>{
    observers.push(observer);
    <span class="hljs-keyword">return</span> {
      dispose: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> index = observers.indexOf(observer);
        <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
          observers.splice(index, <span class="hljs-number">1</span>);
        }
      }
    };
  });</pre></div></div>
                    
                </li>
                
                
                <li id="section-14">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-14">&#182;</a>
                        </div>
                        <h3 id="hasobservaer">hasObservaer</h3>
<p>returns the current number of observers for this action</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  action.hasObservers = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> observers.length &gt; <span class="hljs-number">0</span> ||
      actionStart.hasObservers() ||
      actionEnd.hasObservers();
  };</pre></div></div>
                    
                </li>
                
                
                <li id="section-15">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-15">&#182;</a>
                        </div>
                        <h3 id="waitfor">waitFor</h3>
<p>takes observables as arguments and will
wait for each observable to publish a new value until
All the observers of this action are notified of the new value</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  action.waitFor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(observables)</span> </span>{
    observables = slice.call(<span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">return</span> actionStart
      .flatMap(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
        <span class="hljs-keyword">return</span> Rx.Observable.combineLatest(
          observables.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(observable)</span> </span>{
            observable = observable.takeUntil(actionEnd).publish();
            observable.connect();
            <span class="hljs-keyword">return</span> observable;
          }),
          <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
            <span class="hljs-keyword">return</span> value;
          }
        );
      });
  };

  <span class="hljs-keyword">return</span> action;
}</pre></div></div>
                    
                </li>
                
                
                <li id="section-16">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-16">&#182;</a>
                        </div>
                        <h1 id="createactions">createActions</h1>
<p>Create Actions is a helper function to create multiple actions at once.
It can take a string which will create one action,
an Array of strings,
or an Array of objects with the keys <code>name</code> and <code>map</code>.
This will return an object with a action functions as methods</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createActions</span><span class="hljs-params">(actions)</span> </span>{
  <span class="hljs-keyword">var</span> Actions;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> actions === <span class="hljs-string">'string'</span>) {
    actions = [actions];
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(actions)) {
    Actions = actions.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_Actions, action)</span> </span>{
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> action === <span class="hljs-string">'string'</span>) {
        _Actions[action] = create();
      } <span class="hljs-keyword">else</span> {
        invariant(
          <span class="hljs-keyword">typeof</span> action !== <span class="hljs-string">'object'</span>,
          <span class="hljs-string">'createActions requires items in array to be either strings '</span> +
            <span class="hljs-string">'or objects but was supplied with %s'</span>,
          action
        );

        invariant(
          <span class="hljs-keyword">typeof</span> action.name !== <span class="hljs-string">'string'</span>,
          <span class="hljs-string">'createActions requires objects to have a name key, but got %s'</span>,
          action.name
        );

        <span class="hljs-keyword">if</span> (action.map) {
          invariant(
            <span class="hljs-keyword">typeof</span> action.map !== <span class="hljs-string">'function'</span>,
            <span class="hljs-string">'createActions requires objects with map field to be a function '</span> +
              <span class="hljs-string">'but was given %s'</span>,
            action.map
          );
        }

        _Actions[action.name] = create(action.map);
      }
      <span class="hljs-keyword">return</span> _Actions;
    }, {});
  }

  <span class="hljs-keyword">return</span> Actions;
}

<span class="hljs-built_in">module</span>.exports = {
  create: create,
  createActions: createActions
};</pre></div></div>
                    
                </li>
                
                
                <li id="section-17">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-17">&#182;</a>
                        </div>
                        <h1 id="store">Store</h1>
<p>A ThunderCats Store is an observable. It can update itself
according to observables it listens to passed in through
the <code>getOperations</code> method</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Rx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rx'</span>);
<span class="hljs-keyword">var</span> uuid = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-uuid'</span>);
<span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../utils'</span>);
<span class="hljs-keyword">var</span> invariant = utils.invariant;
<span class="hljs-keyword">var</span> isPromise = utils.isPromise;
<span class="hljs-keyword">var</span> isObservable = utils.isObservable;</pre></div></div>
                    
                </li>
                
                
                <li id="section-18">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-18">&#182;</a>
                        </div>
                        <h2 id="create">Create</h2>
<p>Takes a spec object and returns an Rx Observable ThunderCats store</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(spec)</span> </span>{
  invariant(
    spec &amp;&amp; <span class="hljs-keyword">typeof</span> spec === <span class="hljs-string">'object'</span>,
    <span class="hljs-string">'Store.create(...): expect an object as argument, given : %s'</span>, spec
  );

  invariant(
    spec.getInitialValue &amp;&amp; <span class="hljs-keyword">typeof</span> spec.getInitialValue === <span class="hljs-string">'function'</span>,
    <span class="hljs-string">'Store.create(...): getInitialValue should be a function given : %s'</span>,
    spec.getInitialValue
  );

  invariant(
    !spec.getOperations || <span class="hljs-keyword">typeof</span> spec.getOperations === <span class="hljs-string">'function'</span>,
    <span class="hljs-string">'Store.create(...): getOperations should be a function given : %s'</span>,
    spec.getOperations
  );

  <span class="hljs-keyword">var</span> getInitialValue = spec.getInitialValue;
  <span class="hljs-keyword">var</span> getOperations = spec.getOperations;

  <span class="hljs-keyword">var</span> value = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> observers = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">var</span> operationsMap = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">var</span> operationsStack = [];
  <span class="hljs-keyword">var</span> valueSubscription = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> operationSubscription = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">var</span> isPending = <span class="hljs-literal">true</span>;</pre></div></div>
                    
                </li>
                
                
                <li id="section-19">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-19">&#182;</a>
                        </div>
                        <h3 id="has-observers">Has Observers</h3>
<p><em>internal method</em></p>
<p>returns the number of observers watching this store</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasObservers</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> !!<span class="hljs-built_in">Object</span>.keys(observers).length;
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-20">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-20">&#182;</a>
                        </div>
                        <h3 id="notifyobservers">NotifyObservers</h3>
<p><em>internal method</em></p>
<p>sends the current value held by the store to its observers</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">notifyObservers</span><span class="hljs-params">(error)</span> </span>{
    <span class="hljs-built_in">Object</span>.keys(observers).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(uid)</span> </span>{
      <span class="hljs-keyword">if</span> (error) {
        <span class="hljs-keyword">return</span> observers[uid].onError(error);
      } <span class="hljs-keyword">else</span> {
        observers[uid].onNext(value);
      }
    });
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-21">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-21">&#182;</a>
                        </div>
                        <h3 id="init">init</h3>
<p><em>internal method</em></p>
<p>On first subscription, this function is called to set the initial value
of the store. The <code>getInitialValue</code> method can return a promise,
observable or a plain JavaScript object.</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> initialValue = getInitialValue();
    <span class="hljs-keyword">if</span> (isPromise(initialValue)) {
      initialValue.then(setValue, notifyObservers);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isObservable(initialValue)) {
      valueSubscription = initialValue.subscribe(setValue, notifyObservers);
    } <span class="hljs-keyword">else</span> {
      setValue(initialValue);
    }
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-22">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-22">&#182;</a>
                        </div>
                        <h3 id="setvalue">setValue</h3>
<p><em>internal method</em></p>
<p>overrides the current value held by the store</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setValue</span><span class="hljs-params">(val)</span> </span>{
    value = val;
    isPending = <span class="hljs-literal">false</span>;
    initOperations();
    notifyObservers();
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-23">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-23">&#182;</a>
                        </div>
                        <h3 id="disposeoperations">disposeOperations</h3>
<p><em>internal method</em></p>
<p>Disposes all the stores current subscriptions</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">disposeOperations</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (operationSubscription) {
      operationSubscription.dispose();
    }

    operationSubscription = <span class="hljs-literal">null</span>;
    operationsMap = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
    operationsStack = [];
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-24">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-24">&#182;</a>
                        </div>
                        <h3 id="initoperations">initOperations</h3>
<p><em>internal method</em></p>
<p>gets the observable passed in through getOperations and subscribes the
store to it’s changes</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initOperations</span><span class="hljs-params">()</span> </span>{
    disposeOperations();

    <span class="hljs-keyword">if</span> (getOperations) {
      <span class="hljs-keyword">var</span> operations = getOperations();
      <span class="hljs-keyword">if</span> (!isObservable(operations)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(
          <span class="hljs-string">'getOperations(): should return an observable, given : '</span> + operations
        );
      }
      operationSubscription = operations.subscribe(operationObserver);
    }
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-25">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-25">&#182;</a>
                        </div>
                        <h3 id="dispose">dispose</h3>
<p><em>internal method</em></p>
<p>Disposes the subscription to initial value observable if any
and calls <code>disposeOperations</code></p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispose</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (valueSubscription) {
      valueSubscription.dispose();
    }
    disposeOperations();
    value = <span class="hljs-literal">null</span>;
    valueSubscription = <span class="hljs-literal">null</span>;
    isPending = <span class="hljs-literal">true</span>;
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-26">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-26">&#182;</a>
                        </div>
                        <h3 id="operationobserver">operationObserver</h3>
<p><em>internal method</em></p>
<p>This is the observer that observes the stores operation observable
operations must return an object with at least the property <code>value</code>
or a method <code>transform</code>. It may also have the additional property <code>confirm</code>
which must be a promise. This is used to undo the value held by the store</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">operationObserver</span><span class="hljs-params">(operation)</span> </span>{
    invariant(
      operation &amp;&amp; <span class="hljs-keyword">typeof</span> operation === <span class="hljs-string">'object'</span>,
      <span class="hljs-string">'invalid operation, operations should be an object, given : %s'</span>, operation
    );

    invariant(
      operation.value ||
      (
        operation.transform &amp;&amp;
        <span class="hljs-keyword">typeof</span> operation.transform === <span class="hljs-string">'function'</span>
      ),
      <span class="hljs-string">'invalid operation, '</span> +
      <span class="hljs-string">'operations should have a value or a transform property'</span>
    );

    <span class="hljs-keyword">var</span> oldValue = value;
    value = applyOperation(value, operation);
    notifyObservers();

    <span class="hljs-keyword">var</span> uid = uuid.v1();
    operationsMap[uid] = {
      operation: operation,
      oldValue: oldValue
    };
    operationsStack.push(uid);

    <span class="hljs-keyword">if</span> (<span class="hljs-string">'confirm'</span> <span class="hljs-keyword">in</span> operation) {
      invariant(
        isPromise(operation.confirm),
        <span class="hljs-string">'invalid operation, confirm should be a promise, given : %s'</span>,
        operation.confirm
      );

      operation.confirm.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        confirmOperation(uid);
      }, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        cancelOperation(uid);
      });
    } <span class="hljs-keyword">else</span> {
      confirmOperation(uid);
    }
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-27">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-27">&#182;</a>
                        </div>
                        <h3 id="cancel-operations">Cancel Operations</h3>
<p><em>internal method</em></p>
<p>If thie promise in <code>confirm</code> is rejected, this method reverts the changes
made by the operation tied to this promise.</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cancelOperation</span><span class="hljs-params">(uid)</span> </span>{
    <span class="hljs-keyword">if</span> (!operationsMap[uid]) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">var</span> oldValue = operationsMap[uid].oldValue;
    <span class="hljs-keyword">var</span> index = operationsStack.indexOf(uid);

    value = operationsStack.slice(index + <span class="hljs-number">1</span>).reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value, uid)</span> </span>{
        <span class="hljs-keyword">var</span> descriptor = operationsMap[uid];
        descriptor.oldValue = value;
        <span class="hljs-keyword">return</span> applyOperation(value, descriptor.operation);
    }, oldValue);

    operationsStack.splice(index, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">delete</span> operationsMap[uid];
    notifyObservers();
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-28">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-28">&#182;</a>
                        </div>
                        <h3 id="confirm-operation">Confirm Operation</h3>
<p><em>internal method</em></p>
<p>This method activates when the promise tied to an operation is resolved.</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">confirmOperation</span><span class="hljs-params">(uid)</span> </span>{
    <span class="hljs-keyword">if</span> (!operationsMap[uid]) {
        <span class="hljs-keyword">return</span>;
    }
    operationsMap[uid].confirmed = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">var</span> lastIndex = -<span class="hljs-number">1</span>;
    operationsStack.every(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(uid, index)</span> </span>{
        <span class="hljs-keyword">if</span> (operationsMap[uid].confirmed) {
            <span class="hljs-keyword">delete</span> operationsMap[uid];
            lastIndex = index;
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    });

    operationsStack = operationsStack.slice(lastIndex + <span class="hljs-number">1</span>);
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-29">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-29">&#182;</a>
                        </div>
                        <h3 id="applyoperation">applyOperation</h3>
<p><em>internal method</em></p>
<p>If an operation returns a proper object, this method is called.
It checks to see if a property <code>value</code> exists and returns that, else
it applies the <code>transform</code> method of the operation on the current value
held by the store.</p>
<p>NOTE: If <code>value</code> property is supplied, then the <code>transform</code> method is
simply ignored</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">applyOperation</span><span class="hljs-params">(value, operation)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-string">'value'</span> <span class="hljs-keyword">in</span> operation ?
      operation.value :
      operation.transform(value);
  }</pre></div></div>
                    
                </li>
                
                
                <li id="section-30">
                    <div class="annotation">
                        
                        <div class="pilwrap ">
                            <a class="pilcrow" href="#section-30">&#182;</a>
                        </div>
                        <h3 id="subscribe">Subscribe</h3>
<p>This is the main entry for observers of this <strong>ThunderCats</strong> Store
This method will track all observers and initiate the store.</p>

                    </div>
                    
                    <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subscribe</span><span class="hljs-params">(observer)</span> </span>{

    <span class="hljs-keyword">var</span> uid = uuid.v1();

    <span class="hljs-keyword">if</span> (!hasObservers()) {
      init();
    }

    observers[uid] = observer;

    <span class="hljs-keyword">if</span> (!isPending) {
      observer.onNext(value);
    }

    <span class="hljs-keyword">return</span> Rx.Disposable.create(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">delete</span> observers[uid];
      <span class="hljs-keyword">if</span> (!hasObservers()) {
        dispose();
      }
    });
  }

  <span class="hljs-keyword">return</span> Rx.Observable.create(subscribe);
}

<span class="hljs-built_in">module</span>.exports = {
  create: create
};</pre></div></div>
                    
                </li>
                
            </ul>
        </div>
    </body>
</html>
